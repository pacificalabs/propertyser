<% apartments.each_with_index do |a, index| %>
  <% @features = a&.feature&.attributes&.select { |k, f| f.present? } %>
  <% @features = @features.keys if @features.present? %>
  <% @descriptors = a&.descriptor&.attributes&.select { |k, f| f.present? } %>
  <% @descriptors = @descriptors.keys if @descriptors.present? %>
  <% @amenities = a&.amenity&.attributes&.select { |k, f| f.present? } %>
  <% @amenities = @amenities.keys if @amenities.present? %>
  <% pic = a.featured_photo_id.present? ? a.photos.find(PhotoDescription.find_by_photo_id(a.featured_photo_id).photo_id) : a.photos.first %>
  <% search_title = nil if controller_name == "users" %>
  <% if device_is_mobile? %>
    <!-- Mobile version -->
    <div class="card mt-md-4">
      <div class="card-body apartment-card">
        <div class="row">
          <!-- Image and link -->
          <div class="col-12 image-box">
            <% tag = pic.present? ? image_tag(pic, alt: "", class: "img-fluid img-thumbnail") : '' %>
            <div>
              <%= link_to tag, apartment_path(a, title: search_title), class: "alert-link" %>
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-10">
            <%= render partial: "apartments/display_address", locals: { apartment: a, search_title: search_title } %>
          </div>
          <div class="col-md-8">
            <div class="mt-3 ml-4">
              <%= render partial: "favourites/widget", locals: {apartment: a} %>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="ml-4 mt-2">
            <%= render partial: "apartments/property_values", locals: {apartment: a} %>
          </div>
        </div>
        <div class="row tablet-card-border"></div>
        <div class="mobile-break"></div>
      </div>
    </div>
  <% else %>
    <!-- Desktop version -->
    <div class="row">
      <div class="card w-100 mt-md-4 bg-white">
        <div class="card-body apartment-card">
          <div class="row">
            <!-- Image and link -->
            <div class="col-md-5 order-md-1 image-box">
              <% tag = pic.present? ? image_tag(pic, alt: "", class: "img-fluid img-thumbnail") : "<span class='nounderline m-5'>There was a problem loading the image.</span>".html_safe %>
              <div>
                <%= link_to tag, apartment_path(a, title: search_title), class: "alert-link" %>
              </div>
            </div>
            <!-- Address and property details -->
            <div class="col-md-5 order-md-2">
              <%= render partial: "apartments/display_address", locals: { apartment: a, search_title: search_title } %>
              <div class="ml-3 mt-2">
                <%= render partial: "apartments/property_values", locals: {apartment: a} %>
              </div>
            </div>
            <!-- Favourites widget -->
            <div class="col-md-1 order-md-3 d-flex align-items-center">
              <%= render partial: "favourites/widget", locals: {apartment: a} %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
<% end %>